# 设置令牌过期时间

为了避免繁琐的更换令牌，我将令牌生效时间更改为了24h，为了安全性考虑，后续要进行优化

![image-20231007160458013](苍穹外卖开发注意事项.assets/image-20231007160458013.png)

# 阿里云oss密钥

| AccessKey ID             | AccessKey Secret               |
| ------------------------ | ------------------------------ |
| LTAI5tCx6titsuCKXD1Lhq7m | jyzVja2cI4ryRNJDTOwho3ic7qmc5W |

AccessKey ID

LTAI5t78GQYfQ211tYuB2iFG

AccessKey Secret

0WiTLOsRoeE4RpazRvBHuT2jRqinyv

![image-20231008152115686](苍穹外卖开发注意事项.assets/image-20231008152115686.png)

# 小程序密钥

```
 https://api.weixin.qq.com/sns/jscode2session?
 https://api.weixin.qq.com/sns/jscode2session?
wxf57cd838e909dc76
b0f1aa82501410639e9270fc5d4d76da
```

# 在服务器部署做准备

## 微信支付

### 获取微信支付平台证书、商户私钥文件

作用：保护支付安全

私钥文件

### 内网穿透工具

**作用**

获取一个公网ip，可以映射到本机端口8080

**获取验证地址**

[cpolar - secure introspectable tunnels to localhost](https://dashboard.cpolar.com/auth)



# 微信支付部分代码改动

## 订单支付逻辑

```java
public OrderPaymentVO payment(OrdersPaymentDTO ordersPaymentDTO) throws Exception {
        // 当前登录用户id

        Long userId = BaseContext.getCurrentId();
        User user = userMapper.getById(userId);

        orderMapper.updateStatu();
        /**
        //调用微信支付接口，生成预支付交易单
        JSONObject jsonObject = weChatPayUtil.pay(
                ordersPaymentDTO.getOrderNumber(), //商户订单号
                new BigDecimal(0.01), //支付金额，单位 元
                "苍穹外卖订单", //商品描述
                user.getOpenid() //微信用户的openid
        );
        **/
    	//暂且生成一个JSONObject
        JSONObject jsonObject = new JSONObject();
        if (jsonObject.getString("code") != null && jsonObject.getString("code").equals("ORDERPAID")) {
            throw new OrderBusinessException("该订单已支付");
        }

        OrderPaymentVO vo = jsonObject.toJavaObject(OrderPaymentVO.class);
        vo.setPackageStr(jsonObject.getString("package"));

        //TODO:由于是个人小程序，故不能开通微信支付功能
        paySuccess(ordersPaymentDTO.getOrderNumber());
        return vo;
    }
```

